#!/bin/zsh
# NOTE: need zsh just for the `fzf --header=$'line1\nline2'` to read the `\n` as a new line, dash in linux doesnt support it

# FZF + bluetoothctl

# TODO: implement ctrl-r reload

[ ! "$(uname)" = "Linux" ] && echo "$(tput setaf 1) Only works in Linux" && exit 1

prev_cmd='bluetoothctl info $(awk '\''{print $2}'\'' <<< {})'
out=$(bluetoothctl devices | fzf +m --height 90% \
    --preview "$prev_cmd" \
    --header=$'ctrl-r->reload devices, ctrl-space->reload paired-devices\nctrl-o->connect, ctrl-i->disconnect, enter->info' \
    --bind 'ctrl-r:reload(bluetoothctl devices)' \
    --bind 'ctrl-space:reload(bluetoothctl paired-devices)' \
    --expect='ctrl-o,ctrl-i')
key=$(echo "$out" | head -1)
selection=$(echo "$out" | tail -1)
if [ -n "$selection" ]; then
    device=$(echo "$selection" | awk '{print $2}')
    case "$key" in
        "ctrl-o") bluetoothctl connect "$device" ;;
        "ctrl-i") bluetoothctl disconnect "$device" ;;
        *) bluetoothctl info "$device" ;;
    esac
fi
